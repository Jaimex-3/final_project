sequenceDiagram
    participant P as Proctor
    participant UI as Web Interface
    participant API as Backend Server
    participant ML as ML Service
    participant DB as Database
    participant FS as File Storage
    
    Note over P,FS: Student Check-In Workflow with Identity Verification
    
    P->>UI: Search for student by ID/name
    UI->>API: GET /students/search?query={id}
    API->>DB: SELECT * FROM students WHERE student_number LIKE '%{id}%'
    DB-->>API: Return student record(s)
    API-->>UI: Return student info + registered_photo_path
    UI-->>P: Display student details<br/>Show registered photo
    
    P->>UI: Select student and click "Check In"
    UI->>API: GET /seat-assignments?student_id={id}&exam_id={exam_id}
    API->>DB: SELECT seat_code FROM seat_assignments<br/>WHERE student_id=X AND seating_plan_id IN<br/>(SELECT seating_plan_id FROM seating_plans WHERE exam_id=Y)
    DB-->>API: Return assigned_seat (e.g., "A12")
    API-->>UI: Return assigned seat
    UI-->>P: Display "Assigned Seat: A12"
    
    P->>UI: Capture live photo (or upload)
    UI->>UI: Activate camera/file upload
    P->>UI: Take photo / Select file
    UI-->>P: Show photo preview
    
    P->>UI: Confirm and submit check-in
    UI->>API: POST /check-in/verify<br/>{student_id, exam_id, captured_photo}
    
    API->>FS: Save captured photo
    FS-->>API: Return captured_photo_path
    
    API->>DB: SELECT registered_photo_path FROM students WHERE student_id=X
    DB-->>API: Return registered_photo_path
    
    alt Registered Photo Exists
        API->>ML: verify_face(registered_photo, captured_photo)
        ML->>ML: Load and preprocess images
        ML->>ML: Calculate SSIM similarity
        ML->>ML: Convert to confidence score (0-100%)
        ML->>ML: Apply threshold (>= 75% = MATCH)
        ML-->>API: Return {match: true/false, confidence: 87.5}
        
        API->>API: Check if confidence >= 75%
        
        alt Confidence >= 75%
            Note over API: Verification MATCH
            API->>API: Set verification_result = 'MATCH'
        else Confidence < 75%
            Note over API: Verification NO_MATCH
            API->>API: Set verification_result = 'NO_MATCH'
        end
    else No Registered Photo
        Note over API: Cannot verify - skip ML
        API->>API: Set verification_result = 'PENDING'
    end
    
    API-->>UI: Return verification result + confidence + assigned_seat
    UI-->>P: Display verification result:<br/>"MATCH (87.5%)" or "NO_MATCH (45.2%)"<br/>Show assigned seat: "A12"
    
    alt Verification is NO_MATCH
        UI-->>P: Display warning: "Low confidence - manual review required"
        P->>UI: Choose action:<br/>1. Override (with notes)<br/>2. Reject check-in<br/>3. Retry photo
        
        alt Proctor Overrides
            P->>UI: Enter override notes (e.g., "Student wearing glasses")
            P->>UI: Click "Override and Continue"
            UI->>API: PATCH /check-in/override<br/>{verification_result: 'OVERRIDE', notes}
            API->>API: Update verification_result = 'OVERRIDE'
        else Proctor Rejects
            P->>UI: Click "Reject Check-In"
            UI-->>P: Display "Check-in cancelled"
            Note over P,FS: Workflow ends - no check-in recorded
        end
    end
    
    P->>UI: Enter actual seat student is sitting in
    UI->>API: POST /check-in/complete<br/>{student_id, exam_id, actual_seat,<br/>verification_result, confidence_score}
    
    API->>API: Compare assigned_seat vs actual_seat
    
    alt Seats Match
        API->>API: Set seat_match = TRUE
    else Seat Mismatch
        API->>API: Set seat_match = FALSE
        Note over API: Will create violation
    end
    
    API->>DB: INSERT INTO check_ins<br/>(exam_id, student_id, proctor_id, check_in_time,<br/>captured_photo_path, verification_result,<br/>confidence_score, assigned_seat, actual_seat,<br/>seat_match, notes)
    DB-->>API: Return check_in_id
    
    alt Seat Mismatch Detected
        API->>DB: INSERT INTO violations<br/>(check_in_id, exam_id, student_id, reported_by,<br/>violation_type='SEAT_MISMATCH', severity='LOW',<br/>description='Student in seat {actual} instead of {assigned}',<br/>status='RECORDED')
        DB-->>API: Return violation_id
        Note over API: Seat mismatch violation created
    end
    
    alt Identity Mismatch (NO_MATCH without override)
        API->>DB: INSERT INTO violations<br/>(check_in_id, exam_id, student_id, reported_by,<br/>violation_type='IDENTITY_MISMATCH', severity='HIGH',<br/>description='Photo verification failed (confidence: {score}%)',<br/>evidence_photo_path=captured_photo_path,<br/>status='RECORDED')
        DB-->>API: Return violation_id
        Note over API: Identity mismatch violation created
    end
    
    API->>DB: INSERT INTO audit_logs<br/>(user_id, action_type='check_in_completed',<br/>table_name='check_ins', record_id=check_in_id,<br/>new_value=JSON, ip_address, timestamp)
    DB-->>API: Confirm audit log
    
    API-->>UI: Return success + check_in_id + violations (if any)
    
    alt Violations Created
        UI-->>P: Display "Check-in Complete"<br/>Show warning: "Violations recorded"<br/>List violations with IDs
    else No Violations
        UI-->>P: Display "Check-in Complete - No Issues"
    end
    
    Note over P,FS: Check-in workflow complete
